2. ä¸­æ–‡è¨»è§£çš„å®Œæ•´ç¨‹å¼ç¢¼ï¼ˆåŒ…å«å¥—ä»¶å®‰è£èˆ‡å•Ÿå‹•æŒ‡ä»¤ï¼‰
python
è¤‡è£½
ç·¨è¼¯
# app.py
from flask import Flask, request
import openpyxl
import requests
import threading
import time
import os

# å»ºç«‹ Flask æ‡‰ç”¨
app = Flask(__name__)

# -------------------------
# è«‹æ›¿æ›æˆä½ è‡ªå·±çš„ LINE Channel Access Token å’Œ User ID
CHANNEL_ACCESS_TOKEN = "ä½ çš„_channel_access_token"
USER_ID = "ä½ çš„_userId"

# è¨­å®š HTTP è«‹æ±‚çš„æ¨™é ­ï¼ˆHeaderï¼‰ï¼Œç”¨æ–¼å‘¼å« LINE Messaging API
headers = {
    "Content-Type": "application/json",
    "Authorization": f"Bearer {CHANNEL_ACCESS_TOKEN}"
}

# å›è¦†è¨Šæ¯çµ¦ä½¿ç”¨è€…ï¼ˆç”¨æ–¼ webhook æ”¶åˆ°è¨Šæ¯å¾Œå›è¦†ï¼‰
def reply_message(reply_token, text):
    url = "https://api.line.me/v2/bot/message/reply"
    data = {
        "replyToken": reply_token,
        "messages": [{"type": "text", "text": text}]
    }
    r = requests.post(url, headers=headers, json=data)
    print("å›è¦†ç‹€æ…‹ï¼š", r.status_code)

# ä¸»å‹•æ¨æ’­è¨Šæ¯çµ¦æŒ‡å®š User IDï¼ˆç”¨æ–¼ Excel ç›£æ§ç™¼ç¾æ–°è³‡æ–™æ™‚æ¨æ’­ï¼‰
def push_message(text):
    url = "https://api.line.me/v2/bot/message/push"
    data = {
        "to": USER_ID,
        "messages": [{"type": "text", "text": text}]
    }
    r = requests.post(url, headers=headers, json=data)
    print("æ¨æ’­ç‹€æ…‹ï¼š", r.status_code)

# å–å¾— Excel æœ€æ–°ä¸€åˆ—è³‡æ–™ä¸¦æ ¼å¼åŒ–æˆæ–‡å­—è¨Šæ¯
EXCEL_PATH = os.path.join(os.getcwd(), "å‡ºå…¥ç´€éŒ„.xlsx")

def get_latest_record(filename=EXCEL_PATH):
    try:
        # é–‹å•Ÿ Excel æª”æ¡ˆ
        wb = openpyxl.load_workbook(filename)
        sheet = wb.active
        # è®€å–æœ€å¾Œä¸€åˆ—è³‡æ–™
        last_row = sheet.max_row
        row_data = [cell.value for cell in sheet[last_row]]
        print("è®€åˆ°çš„è³‡æ–™åˆ—ï¼š", row_data)

        # ç¢ºèªè³‡æ–™æ˜¯å¦å®Œæ•´ä¸”ä¸ç‚ºç©º
        if not row_data or len(row_data) < 4 or any(v is None for v in row_data[:4]):
            return None

        date, time_str, name, status = row_data[:4]
        # å›å‚³æ ¼å¼åŒ–çš„è¨Šæ¯
        return f"ğŸ“‹ æœ€æ–°å‡ºå…¥ç´€éŒ„\nğŸ—“ {date} {time_str}\nğŸ‘¤ {name}\nğŸ“Œ ç‹€æ…‹ï¼š{status}"
    except Exception as e:
        print(f"è®€å– Excel ç™¼ç”ŸéŒ¯èª¤ï¼š{e}")
        return None

# æŒçºŒç›£æ§ Excelï¼Œè‹¥æœ‰æ–°è³‡æ–™å°±æ¨æ’­ LINE
def monitor_excel(interval=10):
    last_row_num = 0
    while True:
        try:
            # ç¢ºèª Excel æª”æ¡ˆå­˜åœ¨
            if not os.path.exists(EXCEL_PATH):
                print(f"Excel æª”æ¡ˆä¸å­˜åœ¨ï¼š{EXCEL_PATH}")
                time.sleep(interval)
                continue

            wb = openpyxl.load_workbook(EXCEL_PATH)
            sheet = wb.active
            current_last_row = sheet.max_row

            # æ–°å¢è³‡æ–™æ™‚è§¸ç™¼æ¨æ’­
            if current_last_row > last_row_num:
                last_row_num = current_last_row
                msg = get_latest_record()
                if msg:
                    print("åµæ¸¬åˆ°æ–°è³‡æ–™ï¼Œæ¨æ’­ä¸­ï¼š", msg)
                    push_message(msg)
        except Exception as e:
            print("ç›£æ§ Excel ç™¼ç”ŸéŒ¯èª¤ï¼Œä½†ç¹¼çºŒé‹è¡Œï¼š", e)

        time.sleep(interval)

# Flask webhook è·¯ç”±ï¼Œæ¥æ”¶ LINE å‚³ä¾†çš„äº‹ä»¶
@app.route("/webhook", methods=["POST"])
def webhook():
    body = request.json
    print("æ”¶åˆ° webhookï¼š", body)

    events = body.get("events", [])
    for event in events:
        # åªè™•ç†æ–‡å­—è¨Šæ¯äº‹ä»¶
        if event["type"] == "message" and event["message"]["type"] == "text":
            reply_token = event["replyToken"]
            user_id = event["source"]["userId"]
            text = event["message"]["text"]
            print(f"ç”¨æˆ¶çš„ userIdï¼š{user_id}")
            print(f"è¨Šæ¯å…§å®¹æ˜¯ï¼šã€Œ{text}ã€")
            # å›è¦†æ”¶åˆ°çš„è¨Šæ¯
            reply_message(reply_token, f"æ”¶åˆ°ä½ çš„è¨Šæ¯ï¼š{text}")

    return "OK"

# ä¸»ç¨‹å¼å…¥å£ï¼Œå•Ÿå‹• Excel ç›£æ§åŸ·è¡Œç·’å’Œ Flask ä¼ºæœå™¨
if __name__ == "__main__":
    # å•Ÿå‹•ç›£æ§åŸ·è¡Œç·’ï¼ˆè¨­ç‚º daemonï¼Œä¸»ç¨‹å¼é—œé–‰æ™‚æœƒè‡ªå‹•çµæŸï¼‰
    t = threading.Thread(target=monitor_excel, daemon=True)
    t.start()

    # å•Ÿå‹• Flask ä¼ºæœå™¨ï¼Œç›£è½ 5000 ç«¯å£
    app.run(port=5000)
ç’°å¢ƒè¨­ç½®èˆ‡å•Ÿå‹•æ•™å­¸
å®‰è£å¥—ä»¶

æ‰“é–‹çµ‚ç«¯æ©Ÿï¼ˆCMDã€PowerShell æˆ– VSCode Terminalï¼‰ï¼Œåˆ‡æ›åˆ°ä½ çš„å°ˆæ¡ˆè³‡æ–™å¤¾ï¼ŒåŸ·è¡Œï¼š

bash
è¤‡è£½
ç·¨è¼¯
pip install flask openpyxl requests
é€™æœƒå®‰è£ï¼š

flaskï¼šç¶²é æ¡†æ¶ï¼Œå»ºç«‹ webhook æ¥æ”¶ä¼ºæœå™¨

openpyxlï¼šè®€å– Excel æª”æ¡ˆ

requestsï¼šå‘ LINE API ç™¼é€ HTTP è«‹æ±‚

å•Ÿå‹•ä½ çš„ç¨‹å¼

åœ¨çµ‚ç«¯æ©Ÿï¼ˆç¢ºå®šåœ¨ç¨‹å¼ç¢¼æ‰€åœ¨è³‡æ–™å¤¾ï¼‰è¼¸å…¥ï¼š

bash
è¤‡è£½
ç·¨è¼¯
python app.py
æœƒçœ‹åˆ° Flask ä¼ºæœå™¨å•Ÿå‹•çš„è¨Šæ¯ï¼š

csharp
è¤‡è£½
ç·¨è¼¯
 * Running on http://127.0.0.1:5000/ (Press CTRL+C to quit)
å•Ÿå‹• ngrok

å†é–‹ä¸€å€‹æ–°çš„çµ‚ç«¯æ©Ÿè¦–çª—ï¼ŒåŸ·è¡Œï¼š

bash
è¤‡è£½
ç·¨è¼¯
ngrok http 5000
ngrok æœƒç”¢ç”Ÿä¸€å€‹å…¬é–‹çš„ç¶²å€ï¼Œé¡ä¼¼ï¼š

arduino
è¤‡è£½
ç·¨è¼¯
https://xxxxx.ngrok.io
è¨­å®š LINE Webhook

å°‡ ngrok ç”¢ç”Ÿçš„ç¶²å€åŠ ä¸Š /webhookï¼Œå¡«å…¥ LINE å®˜æ–¹å¸³è™Ÿå¾Œå°çš„ webhook URLï¼Œä¾‹å¦‚ï¼š

arduino
è¤‡è£½
ç·¨è¼¯
https://xxxxx.ngrok.io/webhook
ä¸¦å•Ÿç”¨ webhookã€‚

æ¸¬è©¦

ç”¨ LINE å‚³è¨Šæ¯çµ¦æ©Ÿå™¨äººï¼ŒFlask ç¨‹å¼æœƒæ”¶åˆ°ä¸¦å›è¦†

åœ¨ Excel æ–°å¢è³‡æ–™ï¼Œç›£æ§åŸ·è¡Œç·’æœƒåµæ¸¬åˆ°ä¸¦æ¨æ’­ LINE

å°æé†’
ngrok å…è²»ç‰ˆç¶²å€æœƒè®Šå‹•ï¼Œè‹¥é‡é–‹è¦é‡æ–°è¨­å®š webhook URL

è‹¥è¦é•·æœŸç©©å®šä½¿ç”¨ï¼Œå»ºè­°ä½¿ç”¨æ­£å¼å…¬é–‹ä¼ºæœå™¨æ¶è¨­ç’°å¢ƒ

