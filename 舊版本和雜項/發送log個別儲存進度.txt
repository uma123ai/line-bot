# -*- coding: utf-8 -*-
import os
import time
import threading
import requests
import json
from flask import Flask, request
from openpyxl import load_workbook

app = Flask(__name__)

# ===== åŸºæœ¬è¨­å®š =====
CHANNEL_ACCESS_TOKEN = "ä½ çš„é »é“å­˜å–ä»¤ç‰Œ"
HEADERS = {
    "Content-Type": "application/json",
    "Authorization": f"Bearer {CHANNEL_ACCESS_TOKEN}"
}

EXCEL_FILE = "å‡ºå…¥ç´€éŒ„.xlsx"
USER_ID_FILE = "user_ids.txt"
PROGRESS_FILE = "user_progress.json"  # ç”¨ä¾†è¨˜éŒ„æ¯å€‹ user_id å·²è®€åˆ° Excel çš„è¡Œæ•¸

# ===== æ¨æ’­è¨Šæ¯çµ¦å–®ä¸€ä½¿ç”¨è€… =====
def push_message(text, user_id):
    data = {
        "to": user_id,
        "messages": [{"type": "text", "text": text}]
    }
    url = "https://api.line.me/v2/bot/message/push"
    r = requests.post(url, headers=HEADERS, json=data)
    print(f"ğŸ”” æ¨æ’­çµ¦ {user_id}ï¼š{r.status_code}")

# ===== å„²å­˜ userIdï¼ˆé¿å…é‡è¤‡ï¼‰=====
def save_user_id(user_id):
    if not os.path.exists(USER_ID_FILE):
        with open(USER_ID_FILE, "w") as f:
            pass
    with open(USER_ID_FILE, "r+") as f:
        ids = [line.strip() for line in f]
        if user_id not in ids:
            f.write(user_id + "\n")
            print(f"âœ… å„²å­˜æ–° userIdï¼š{user_id}")

# ===== è®€å–æ‰€æœ‰å„²å­˜éçš„ userId =====
def load_user_ids():
    if not os.path.exists(USER_ID_FILE):
        return []
    with open(USER_ID_FILE, "r") as f:
        return [line.strip() for line in f if line.strip()]

# ===== è®€å–ä½¿ç”¨è€…é€²åº¦æª” =====
def load_progress():
    if not os.path.exists(PROGRESS_FILE):
        return {}
    with open(PROGRESS_FILE, "r", encoding="utf-8") as f:
        return json.load(f)

# ===== å„²å­˜ä½¿ç”¨è€…é€²åº¦æª” =====
def save_progress(progress):
    with open(PROGRESS_FILE, "w", encoding="utf-8") as f:
        json.dump(progress, f, ensure_ascii=False, indent=2)

# ===== å–å¾— Excel æŒ‡å®šè¡Œç¯„åœçš„æ–°è³‡æ–™ =====
def get_new_rows(start, end):
    try:
        wb = load_workbook(EXCEL_FILE)
        sheet = wb.active
        msgs = []
        for row in range(start + 1, end + 1):
            values = [cell.value for cell in sheet[row][:4]]
            if len(values) < 4 or any(v is None for v in values):
                continue
            date, time_str, name, status = values
            msg = f"ğŸ“‹ æ–°å‡ºå…¥ç´€éŒ„\nğŸ—“ {date} {time_str}\nğŸ‘¤ {name}\nğŸ“Œ ç‹€æ…‹ï¼š{status}"
            msgs.append(msg)
        return msgs
    except Exception as e:
        return [f"âš ï¸ Excel è®€å–éŒ¯èª¤ï¼š{e}"]

# ===== èƒŒæ™¯åŸ·è¡Œï¼šæ¯ 10 ç§’åµæ¸¬ Excel æ–°è³‡æ–™ä¸¦æ¨æ’­çµ¦æ¯å€‹ä½¿ç”¨è€… =====
def monitor_excel(interval=10):
    progress = load_progress()  # è¼‰å…¥æ‰€æœ‰ä½¿ç”¨è€…çš„æ¨æ’­é€²åº¦
    while True:
        try:
            if not os.path.exists(EXCEL_FILE):
                print(f"âŒ æ‰¾ä¸åˆ° {EXCEL_FILE}")
                time.sleep(interval)
                continue

            wb = load_workbook(EXCEL_FILE)
            sheet = wb.active
            current_last_row = sheet.max_row

            user_ids = load_user_ids()
            for user_id in user_ids:
                last_read = progress.get(user_id, 1)  # æ²’è¨˜éŒ„é è¨­å¾ç¬¬2è¡Œé–‹å§‹ï¼ˆå‡è¨­ç¬¬1è¡Œæ˜¯æ¨™é¡Œï¼‰
                if current_last_row > last_read:
                    new_msgs = get_new_rows(last_read, current_last_row)
                    for msg in new_msgs:
                        push_message(msg, user_id)
                    progress[user_id] = current_last_row  # æ›´æ–°è©²ä½¿ç”¨è€…çš„æ¨æ’­é€²åº¦

            save_progress(progress)  # å¯«å›é€²åº¦æª”
        except Exception as e:
            print("âŒ ç›£æ§éŒ¯èª¤ï¼š", e)
        time.sleep(interval)

# ===== Webhook æ¥æ”¶ LINE è¨Šæ¯ =====
@app.route("/webhook", methods=["POST"])
def webhook():
    body = request.json
    events = body.get("events", [])
    for event in events:
        if event["type"] == "message":
            user_id = event["source"]["userId"]
            text = event["message"]["text"]
            reply_token = event["replyToken"]

            save_user_id(user_id)  # å„²å­˜ userId
            reply_message(reply_token, f"ğŸ‘‹ å“ˆå›‰ï¼Œæˆ‘å·²æ”¶åˆ°ä½ çš„è¨Šæ¯ï¼š{text}")
    return "OK"

# ===== å›è¦†ä½¿ç”¨è€…è¨Šæ¯ =====
def reply_message(reply_token, text):
    url = "https://api.line.me/v2/bot/message/reply"
    data = {
        "replyToken": reply_token,
        "messages": [{"type": "text", "text": text}]
    }
    requests.post(url, headers=HEADERS, json=data)

# ===== å•Ÿå‹•ç¨‹å¼ =====
if __name__ == "__main__":
    print("âœ… å•Ÿå‹• Flask + Excel ç›£æ§ä¸­...")
    threading.Thread(target=monitor_excel, daemon=True).start()
    app.run(port=5000)
